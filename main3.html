<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¹ä¹ä¹˜æ³•å¤§æŒ‘æˆ°</title>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
            background-color: #FFF8E7;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none; /* é è¨­éš±è—ï¼Œç”± JS æ§åˆ¶é¡¯ç¤º */
            flex-direction: column;
        }

        .active {
            display: flex;
        }

        .center-flex {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-sizing: border-box;
            position: relative;
        }

        /* --- é¦–é æ¨£å¼ --- */
        #home-zone-1 { /* æ¨™é¡Œ */
            height: 25%;
            font-size: 3rem;
            font-weight: 900;
            color: #FF6B6B;
            text-shadow: 2px 2px 0px #fff;
        }

        #home-zone-2 { /* èªªæ˜æ–‡å­— */
            height: 25%;
            padding: 0 20px;
            font-size: 1.2rem;
            color: #555;
            line-height: 1.6;
        }

        #home-zone-3 { /* é¸é …å€ */
            height: 30%;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 10px;
            padding: 10px 20px;
        }

        .num-toggle {
            background-color: #eee;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.5rem;
            color: #aaa;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .num-toggle.selected {
            background-color: #4ECDC4;
            border-color: #45b7af;
            color: white;
            font-weight: bold;
            box-shadow: 0 3px 0 #2a8a83;
        }

        #home-zone-4 { /* é–‹å§‹æŒ‰éˆ•å€ */
            height: 20%;
        }

        .btn-ellipse {
            width: 60%;
            padding: 15px 0;
            border-radius: 50px;
            border: none;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            box-shadow: 0 5px 0 rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .btn-ellipse:active { transform: translateY(4px); box-shadow: none; }
        .bg-start { background-color: #FF6B6B; }

        /* --- éŠæˆ²é æ¨£å¼ --- */
        #game-zone-1 { /* å›é¥‹èˆ‡å‹•ç•« */
            height: 20%;
            font-size: 1.8rem;
            font-weight: bold;
            flex-direction: column;
            background-color: #fff;
            border-bottom: 1px solid #eee;
        }
        .feedback-text { margin-bottom: 5px; }
        .feedback-anim { font-size: 3rem; height: 60px; }

        /* å‹•ç•«å®šç¾© */
        @keyframes clap {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.3) rotate(-10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        .anim-clap { animation: clap 0.5s ease-in-out infinite; }
        .anim-shake { animation: shake 0.3s ease-in-out infinite; }

        #game-zone-2 { /* åˆ†æ•¸ */
            height: 5%;
            background-color: #f0f0f0;
            font-size: 1rem;
            color: #333;
            justify-content: flex-end;
            padding-right: 20px;
        }

        #game-zone-3 { /* é¡Œç›® */
            height: 15%;
            font-size: 3.5rem;
            font-weight: 800;
            color: #2c3e50;
        }

        #game-zone-4 { /* ç­”æ¡ˆé¸é … 40% */
            height: 40%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 15px;
            padding: 15px;
        }

        .ans-btn {
            background-color: #FFB6C1; /* æ·ºç²‰è‰² */
            border: none;
            border-radius: 8px; /* é•·æ–¹å½¢ */
            font-size: 2.2rem;
            color: #444;
            box-shadow: 0 4px 5px rgba(0,0,0,0.1);
        }
        .ans-btn:active { transform: scale(0.98); }
        .ans-btn.disabled { opacity: 0.6; pointer-events: none; }

        #game-zone-5 { /* æ§åˆ¶æŒ‰éˆ• 20% */
            height: 20%;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .btn-control {
            width: 40%;
            height: 60%;
            border-radius: 50px;
            border: none;
            font-size: 1.3rem;
            color: white;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        .bg-end { background-color: #95a5a6; }
        .bg-next { background-color: #2ECC71; }

        /* --- çµç®—å½ˆçª— --- */
        #modal-result {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-box {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            width: 80%;
        }
    </style>
</head>
<body>

    <div id="screen-home" class="screen active">
        <div id="home-zone-1" class="center-flex">ä¹ä¹ä¹˜æ³•</div>
        <div id="home-zone-2" class="center-flex">
            ä¹ä¹ä¹˜æ³•æ¯”è³½éŠæˆ²ï¼Œè¨ˆæ™‚3åˆ†é˜ï¼Œä»¥ä¸‹å¯è¤‡é¸è¦è€ƒçš„ç¯„åœï¼Œå†æŒ‰â€œéŠæˆ²é–‹å§‹â€éµã€‚
        </div>
        <div id="home-zone-3">
            </div>
        <div id="home-zone-4" class="center-flex">
            <button class="btn-ellipse bg-start" onclick="startGame()">éŠæˆ²é–‹å§‹</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div id="game-zone-1" class="center-flex">
            <div id="feedback-text" class="feedback-text"></div>
            <div id="feedback-anim" class="feedback-anim"></div>
        </div>
        <div id="game-zone-2" class="center-flex">
            ä½ ç­”å° <span id="score-val" style="color:red; margin:0 5px; font-weight:bold;">0</span> é¡Œ | å‰©é¤˜ <span id="time-val" style="margin-left:5px">180</span> ç§’
        </div>
        <div id="game-zone-3" class="center-flex">
            </div>
        <div id="game-zone-4">
            <button class="ans-btn" onclick="checkAnswer(0)"></button>
            <button class="ans-btn" onclick="checkAnswer(1)"></button>
            <button class="ans-btn" onclick="checkAnswer(2)"></button>
            <button class="ans-btn" onclick="checkAnswer(3)"></button>
        </div>
        <div id="game-zone-5">
            <button class="btn-control bg-end" onclick="endGameByUser()">çµæŸ</button>
            <button class="btn-control bg-next" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>

    <div id="modal-result">
        <div class="modal-box">
            <h2 style="color:#2ECC71">æ™‚é–“åˆ°ï¼</h2>
            <p id="final-msg" style="font-size:1.5rem; margin:20px 0;">æ­å–œï¼ä½ ç­”å° ? é¡Œ</p>
            <button class="btn-ellipse bg-start" onclick="location.reload()">é‡æ–°é–‹å§‹</button>
        </div>
    </div>

    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        let audioCtx;
        let selectedNumbers = new Set([2,3,4,5,6,7,8,9]); // é è¨­å…¨é¸
        let score = 0;
        let timerSeconds = 180;
        let timerInterval;
        let currentAnswer = 0;
        let isAnswered = false;
        let hasSpokenIntro = false;
        
        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            renderNumberToggles();
            
            // å˜—è©¦è‡ªå‹•æœ—è®€ (è‹¥ç€è¦½å™¨æ”¯æ´ä¸¦å…è¨±)
            if (!hasSpokenIntro) {
                speakText("ä¹ä¹ä¹˜æ³•æ¯”è³½éŠæˆ²ï¼Œè¨ˆæ™‚3åˆ†é˜ï¼Œä»¥ä¸‹å¯è¤‡é¸è¦è€ƒçš„ç¯„åœï¼Œå†æŒ‰â€œéŠæˆ²é–‹å§‹â€éµã€‚");
                hasSpokenIntro = true;
            }
        };

        // --- èªéŸ³åˆæˆ (TTS) ---
        function speakText(text) {
            if ('speechSynthesis' in window) {
                // å–æ¶ˆä¹‹å‰å¯èƒ½æ­£åœ¨èªªçš„
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = 1.0;
                
                // å˜—è©¦æ’­æ”¾
                window.speechSynthesis.speak(utterance);
            }
        }

        // --- é¦–é é‚è¼¯ ---
        function renderNumberToggles() {
            const container = document.getElementById('home-zone-3');
            container.innerHTML = '';
            for (let i = 2; i <= 9; i++) {
                const btn = document.createElement('div');
                btn.className = 'num-toggle selected'; // é è¨­å…¨é¸
                btn.innerText = i;
                btn.onclick = () => toggleNumber(i, btn);
                container.appendChild(btn);
            }
        }

        function toggleNumber(num, btn) {
            // ç”¨æˆ¶äº’å‹•æ™‚ï¼Œç¢ºä¿ AudioContext æº–å‚™å¥½ (ç‚ºäº†å¾Œé¢çš„éŠæˆ²éŸ³æ•ˆ)
            initAudioContext();

            if (selectedNumbers.has(num)) {
                if (selectedNumbers.size > 1) { // è‡³å°‘ä¿ç•™ä¸€å€‹
                    selectedNumbers.delete(num);
                    btn.classList.remove('selected');
                }
            } else {
                selectedNumbers.add(num);
                btn.classList.add('selected');
            }
        }

        function startGame() {
            if (selectedNumbers.size === 0) return;
            
            // ç¢ºä¿ AudioContext æº–å‚™å¥½
            initAudioContext();

            // åœæ­¢é¦–é èªéŸ³
            window.speechSynthesis.cancel();

            // åˆ‡æ›ç•«é¢
            document.getElementById('screen-home').classList.remove('active');
            document.getElementById('screen-game').classList.add('active');

            // åˆå§‹åŒ–éŠæˆ²æ•¸æ“š
            score = 0;
            timerSeconds = 180;
            updateScoreUI();
            
            // å•Ÿå‹•è¨ˆæ™‚å™¨
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timerSeconds--;
                document.getElementById('time-val').innerText = timerSeconds;
                if (timerSeconds <= 0) {
                    timeUp();
                }
            }, 1000);

            // å‡ºç¬¬ä¸€é¡Œ
            nextQuestion();
        }

        // --- éŸ³æ•ˆå¼•æ“åˆå§‹åŒ– (Lazy Load) ---
        function initAudioContext() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) {
                    audioCtx = new AudioContext();
                }
            }
            if (audioCtx && audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // --- éŠæˆ²é‚è¼¯ ---
        function nextQuestion() {
            if (timerSeconds <= 0) return;

            // é‡ç½® UI
            isAnswered = false;
            document.getElementById('feedback-text').innerText = "";
            document.getElementById('feedback-text').className = "feedback-text";
            document.getElementById('feedback-anim').innerText = "";
            document.getElementById('feedback-anim').className = "feedback-anim";

            const opts = document.querySelectorAll('.ans-btn');
            opts.forEach(btn => {
                btn.classList.remove('disabled');
                btn.style.backgroundColor = "#FFB6C1"; // æ¢å¾©æ·ºç²‰è‰²
            });

            // ç”¢ç”Ÿé¡Œç›®
            const multipliers = Array.from(selectedNumbers);
            const num1 = multipliers[Math.floor(Math.random() * multipliers.length)];
            const num2 = Math.floor(Math.random() * 9) + 1;
            currentAnswer = num1 * num2;

            document.getElementById('game-zone-3').innerText = `${num1} Ã— ${num2} = ?`;

            // ç”¢ç”Ÿé€£çºŒæ•¸å­—é¸é …
            generateOptions(currentAnswer);
        }

        function generateOptions(ans) {
            // ç”¢ç”ŸåŒ…å«æ­£ç¢ºç­”æ¡ˆçš„é€£çºŒ 4 å€‹æ•¸å­—
            let start = ans - Math.floor(Math.random() * 4);
            if (start < 1) start = 1; 

            let vals = [start, start+1, start+2, start+3];
            
            // æ´—ç‰Œä½ç½®
            vals.sort(() => Math.random() - 0.5);

            const btns = document.querySelectorAll('.ans-btn');
            btns.forEach((btn, idx) => {
                btn.innerText = vals[idx];
                btn.dataset.val = vals[idx];
            });
        }

        function checkAnswer(btnIndex) {
            if (isAnswered) return;
            isAnswered = true;
            
            // ç­”é¡Œæ™‚ä¹Ÿç¢ºä¿éŸ³æ•ˆå¯ç”¨
            initAudioContext();

            const btns = document.querySelectorAll('.ans-btn');
            const clickedBtn = btns[btnIndex];
            const val = parseInt(clickedBtn.dataset.val);

            // é–å®šæ‰€æœ‰æŒ‰éˆ•
            btns.forEach(b => b.classList.add('disabled'));

            const feedbackText = document.getElementById('feedback-text');
            const feedbackAnim = document.getElementById('feedback-anim');

            if (val === currentAnswer) {
                // ç­”å°
                score++;
                updateScoreUI();
                feedbackText.innerText = "å¤ªæ£’äº†ï¼ä½ ç­”å°äº†";
                feedbackText.style.color = "#2ECC71";
                feedbackAnim.innerText = "ğŸ‘"; // æ‹æ‰‹
                feedbackAnim.classList.add('anim-clap');
                playTone('win');
                clickedBtn.style.backgroundColor = "#2ECC71"; // æŒ‰éˆ•è®Šç¶ 
            } else {
                // ç­”éŒ¯
                feedbackText.innerText = "å–”å–”ï¼å†æƒ³æƒ³";
                feedbackText.style.color = "#E74C3C";
                feedbackAnim.innerText = "ğŸ˜”"; // æ–é ­/å¤±æœ›
                feedbackAnim.classList.add('anim-shake');
                playTone('lose');
                clickedBtn.style.backgroundColor = "#E74C3C"; // æŒ‰éˆ•è®Šç´…
            }
        }

        function updateScoreUI() {
            document.getElementById('score-val').innerText = score;
        }

        function endGameByUser() {
            clearInterval(timerInterval);
            location.reload(); 
        }

        function timeUp() {
            clearInterval(timerInterval);
            document.getElementById('modal-result').style.display = 'flex';
            document.getElementById('final-msg').innerText = `æ­å–œï¼ä½ ç­”å° ${score} é¡Œ`;
            playTone('win'); 
        }

        // --- éŸ³æ•ˆç”¢ç”Ÿ (Oscillator) ---
        function playTone(type) {
            if (!audioCtx) return;
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;

            if (type === 'win') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, now); // C5
                osc.frequency.setValueAtTime(659.25, now + 0.1); // E5
                osc.frequency.setValueAtTime(783.99, now + 0.2); // G5
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            } else {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.3);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            }
        }
    </script>
</body>
</html>
