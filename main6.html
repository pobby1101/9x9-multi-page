<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¹ä¹ä¹˜æ³•æŒ‘æˆ° (90ç§’ç‰ˆ)</title>
    <style>
        /* --- å…¨å±€è¨­å®š --- */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
            background-color: #FFF8E7; /* æº«æš–çš„ç±³é»ƒè‰²èƒŒæ™¯ */
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none; /* iOS ç¦æ­¢é¸å–æ–‡å­— */
            -webkit-touch-callout: none;
        }

        /* éš±è—/é¡¯ç¤ºè¢å¹•æ§åˆ¶ */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }
        .active { display: flex; }

        /* é€šç”¨ Flex ç½®ä¸­ */
        .center-flex {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-sizing: border-box;
            position: relative;
        }

        /* --- é¦–é  (Home) --- */
        #home-zone-1 { /* 25% æ¨™é¡Œ */
            height: 25%;
            font-size: 3.5rem;
            font-weight: 900;
            color: #FF6B6B;
            text-shadow: 2px 2px 0 #fff;
        }

        #home-zone-2 { /* 25% èªªæ˜èˆ‡æœ—è®€ */
            height: 25%;
            padding: 0 30px;
            font-size: 1.2rem;
            color: #555;
            line-height: 1.6;
            flex-direction: column;
        }
        
        /* å–‡å­æŒ‰éˆ•æ¨£å¼ */
        .speaker-btn {
            font-size: 2.5rem;
            margin-bottom: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            background: none;
            border: none;
            outline: none;
        }
        .speaker-btn:active { transform: scale(0.9); }

        #home-zone-3 { /* 30% è¤‡é¸å€ */
            height: 30%;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 12px;
            padding: 10px 25px;
        }

        .num-toggle {
            text-decoration: line-through;
            background-color: #eee;
            border: 2px solid #ddd;
            border-radius: 12px;
            font-size: 1.8rem;
            color: #aaa;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .num-toggle.selected {
            text-decoration: none;
            background-color: #4ECDC4;
            border-color: #3ebcb4;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 0 #2a8a83;
            transform: translateY(-2px);
        }

        #home-zone-4 { /* 20% é–‹å§‹æŒ‰éˆ• */
            height: 20%;
        }

        /* æ©¢åœ“æŒ‰éˆ•é€šç”¨æ¨£å¼ */
        .btn-ellipse {
            width: 60%;
            padding: 15px 0;
            border-radius: 50px;
            border: none;
            font-size: 1.6rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            box-shadow: 0 5px 0 rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .btn-ellipse:active { transform: translateY(4px); box-shadow: none; }
        .bg-start { background-color: #FF6B6B; }

        /* --- éŠæˆ²é  (Game) --- */
        #game-zone-1 { /* 20% å›é¥‹å€ */
            height: 20%;
            font-size: 2rem;
            font-weight: bold;
            flex-direction: column;
            background-color: #fff;
            border-bottom: 2px solid #eee;
        }
        .feedback-anim { font-size: 3.5rem; height: 70px; margin-top: 5px; }

        /* å‹•ç•« Keyframes */
        @keyframes clap {
            0% { transform: scale(1); }
            50% { transform: scale(1.3) rotate(-15deg); }
            100% { transform: scale(1); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-10px); }
            40%, 80% { transform: translateX(10px); }
        }
        .anim-clap { animation: clap 0.5s ease-in-out infinite; }
        .anim-shake { animation: shake 0.4s ease-in-out; } /* æ–é ­åªæ–ä¸€æ¬¡è¼ƒè‡ªç„¶ */

        #game-zone-2 { /* 5% åˆ†æ•¸èˆ‡æ™‚é–“ */
            height: 5%;
            background-color: #f8f9fa;
            font-size: 1rem;
            color: #333;
            justify-content: space-between; /* å·¦å³åˆ†ä½ˆ */
            padding: 0 20px;
            border-bottom: 1px solid #ddd;
        }

        #game-zone-3 { /* 15% é¡Œç›® */
            height: 15%;
            font-size: 4rem;
            font-weight: 800;
            color: #2c3e50;
            font-family: monospace; /* è®“æ•¸å­—å°é½Šæ›´å¥½çœ‹ */
        }

        #game-zone-4 { /* 40% ç­”æ¡ˆçŸ©é™£ */
            height: 40%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 15px;
            padding: 15px 25px;
        }

        .ans-btn {
            background-color: #FFB6C1; /* æ·ºç²‰è‰² */
            border: none;
            border-radius: 10px; /* é•·æ–¹å½¢ */
            font-size: 2.5rem;
            color: #444;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .ans-btn:active { transform: scale(0.98); }
        
        /* ç­”éŒ¯å¾Œçš„æŒ‰éˆ•æ¨£å¼ */
        .ans-btn.wrong-choice {
            background-color: #ccc !important;
            color: #888;
            pointer-events: none; /* è®“å®ƒä¸èƒ½å†è¢«æŒ‰ */
        }
        /* é–å®šå…¨éƒ¨æŒ‰éˆ• */
        .ans-btn.locked { pointer-events: none; }

        #game-zone-5 { /* 20% æ§åˆ¶æŒ‰éˆ• */
            height: 20%;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .btn-control {
            width: 40%;
            height: 60%;
            border-radius: 50px;
            border: none;
            font-size: 1.3rem;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            cursor: pointer;
        }
        .btn-control:active { transform: translateY(4px); box-shadow: none; }
        .bg-end { background-color: #95a5a6; }
        .bg-next { background-color: #2ECC71; }

        /* --- çµç®—å½ˆçª— --- */
        #modal-result {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-box {
            background: white;
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            width: 80%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <div id="screen-home" class="screen active">
        <div id="home-zone-1" class="center-flex">ä¹ä¹ä¹˜æ³•</div>
        
        <div id="home-zone-2" class="center-flex">
            <button class="speaker-btn" onclick="readInstruction()">ğŸ”Š</button>
            <div id="instruction-text">
                ä¹ä¹ä¹˜æ³•æ¯”è³½éŠæˆ²ï¼Œè¨ˆæ™‚90ç§’ï¼Œä»¥ä¸‹å¯è¤‡é¸è¦è€ƒçš„ç¯„åœï¼Œå†æŒ‰â€œéŠæˆ²é–‹å§‹â€éµã€‚
            </div>
        </div>

        <div id="home-zone-3">
            </div>

        <div id="home-zone-4" class="center-flex">
            <button class="btn-ellipse bg-start" onclick="startGame()">éŠæˆ²é–‹å§‹</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div id="game-zone-1" class="center-flex">
            <div id="feedback-text"></div>
            <div id="feedback-anim" class="feedback-anim"></div>
        </div>
        
        <div id="game-zone-2" class="center-flex">
            <span>ç­”å°: <b id="score-val" style="color:#e74c3c">0</b> é¡Œ</span>
            <span>ç­”éŒ¯: <b id="fault-val" style="color:#e74c3c">0</b> æ¬¡</span>
            <span>æ™‚é–“: <b id="time-val" style="color:#2980b9">90</b> ç§’</span>
        </div>

        <div id="game-zone-3" class="center-flex">
            </div>

        <div id="game-zone-4">
            <button class="ans-btn" onclick="checkAnswer(0)"></button>
            <button class="ans-btn" onclick="checkAnswer(1)"></button>
            <button class="ans-btn" onclick="checkAnswer(2)"></button>
            <button class="ans-btn" onclick="checkAnswer(3)"></button>
        </div>

        <div id="game-zone-5">
            <button class="btn-control bg-end" onclick="endGameNow()">çµæŸ</button>
            <button class="btn-control bg-next" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>

    <div id="modal-result">
        <div class="modal-box">
            <h2 style="color:#2ECC71; font-size:2rem; margin-bottom:10px;">æ™‚é–“åˆ°ï¼æ­å–œï¼</h2>
            <p id="final-msg" style="font-size:1.5rem; margin:20px 0; color:#555;">ç­”å° ? é¡Œ</p>
            <button class="btn-ellipse bg-start" onclick="location.reload()">é‡æ–°é–‹å§‹</button>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒè®Šæ•¸ ---
        let audioCtx;
        let selectedMatrixB = new Set([2,3,4,5,6,7,8,9]); // é è¨­å…¨é¸
        let score = 0;
        let faultScore = 0;
        let timerSeconds = 90; // è¨ˆæ™‚ 90 ç§’
        let timerInterval;
        let currentAnswer = 0;
        let isRoundFinished = false; // æ˜¯å¦è©²é¡Œå·²çµæŸ(å·²ç­”å°)

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            renderNumberToggles();
        };

        // --- åŠŸèƒ½ï¼šWeb Audio API éŸ³æ•ˆ ---
        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) audioCtx = new AudioContext();
            }
            if (audioCtx && audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playTone(type) {
            // å˜—è©¦å•Ÿå‹•éŸ³æ•ˆ
            initAudio(); 
            if (!audioCtx) return;

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'win') {
                // å‹åˆ©éŸ³æ•ˆ (Do-Mi-So High)
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, now);
                osc.frequency.setValueAtTime(659.25, now + 0.1);
                osc.frequency.setValueAtTime(783.99, now + 0.2);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.6);
                osc.start(now);
                osc.stop(now + 0.6);
            } else if (type === 'lose') {
                // å¤±æ•—éŸ³æ•ˆ (Low Sawtooth)
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(80, now + 0.3);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            }
        }

        // --- åŠŸèƒ½ï¼šèªéŸ³æœ—è®€ (TTS) ---
        function readInstruction() {
            // åœ¨é»æ“Šå–‡å­æ™‚ï¼Œé †ä¾¿è§£é– AudioContext
            initAudio();

            const text = document.getElementById('instruction-text').innerText;
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); // åœæ­¢ä¹‹å‰çš„
                const msg = new SpeechSynthesisUtterance(text);
                msg.lang = 'zh-TW';
                msg.rate = 1.0;
                window.speechSynthesis.speak(msg);
            }
        }

        // --- ç•«é¢é‚è¼¯ï¼šé¦–é  ---
        function renderNumberToggles() {
            const container = document.getElementById('home-zone-3');
            container.innerHTML = '';
            for (let i = 2; i <= 9; i++) {
                const btn = document.createElement('div');
                btn.className = 'num-toggle selected';
                btn.innerText = i;
                btn.onclick = () => {
                    // é»æ“Šé¸é …æ™‚ä¹Ÿç¢ºä¿éŸ³æ•ˆç’°å¢ƒæº–å‚™å¥½
                    initAudio();
                    if (selectedMatrixB.has(i)) {
                        if (selectedMatrixB.size > 1) { // è‡³å°‘ç•™ä¸€å€‹
                            selectedMatrixB.delete(i);
                            btn.classList.remove('selected');
                        }
                    } else {
                        selectedMatrixB.add(i);
                        btn.classList.add('selected');
                    }
                };
                container.appendChild(btn);
            }
        }

        function startGame() {
            if (selectedMatrixB.size === 0) return;

            // åœæ­¢æœ—è®€
            window.speechSynthesis.cancel();
            // ç¢ºä¿éŸ³æ•ˆè§£é–
            initAudio();

            // åˆ‡æ›ç•«é¢
            document.getElementById('screen-home').classList.remove('active');
            document.getElementById('screen-game').classList.add('active');

            // é‡ç½®æ•¸æ“š
            score = 0;
            timerSeconds = 90; // 90ç§’
            updateUI();

            // å•Ÿå‹•è¨ˆæ™‚
            timerInterval = setInterval(() => {
                timerSeconds--;
                document.getElementById('time-val').innerText = timerSeconds;
                if (timerSeconds <= 0) {
                    gameOver();
                }
            }, 1000);

            // å‡ºé¡Œ
            nextQuestion();
        }

        // --- ç•«é¢é‚è¼¯ï¼šéŠæˆ²ä¸­ ---
        function nextQuestion() {
            if (timerSeconds <= 0) return;

            isRoundFinished = false;

            // æ¸…ç©ºå›é¥‹
            const fbText = document.getElementById('feedback-text');
            const fbAnim = document.getElementById('feedback-anim');
            fbText.innerText = "";
            fbAnim.innerText = "";
            fbAnim.className = "feedback-anim";

            // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
            const btns = document.querySelectorAll('.ans-btn');
            btns.forEach(btn => {
                btn.className = 'ans-btn'; // ç§»é™¤ wrong-choice, locked
                btn.style.backgroundColor = '#FFB6C1'; // æ·ºç²‰è‰²
                btn.style.pointerEvents = 'auto'; // æ¢å¾©é»æ“Š
            });

            // éš¨æ©Ÿé¸é¡Œï¼šçŸ©é™£è®Šæ•¸ B (selectedMatrixB)
            const multiplicands = Array.from(selectedMatrixB);
            const num1 = multiplicands[Math.floor(Math.random() * multiplicands.length)]; // è¢«ä¹˜æ•¸
            const num2 = Math.floor(Math.random() * 9) + 1; // ä¹˜æ•¸ (1-9)
            currentAnswer = num1 * num2;

            document.getElementById('game-zone-3').innerText = `${num1} Ã— ${num2} = ?`;

            // ç”¢ç”Ÿé€£çºŒæ•¸å­—é¸é …
            generateConsecutiveOptions(currentAnswer, num1);
        }

        function generateConsecutiveOptions(answer, multiplicand) {
            // ç”¢ç”ŸåŒ…å«æ­£ç¢ºç­”æ¡ˆçš„ 4 çµ„æ•¸å­—
            // éš¨æ©Ÿåç§» offset (0~3)ï¼Œè®“ç­”æ¡ˆå‡ºç¾åœ¨ä¸åŒä½ç½®
            let start = answer - Math.floor(Math.random() * 4);
            if (start < 1) start = 1; // æœ€å°ç‚º 1
            //let optionsArr = [start, start+1, start+2, start+3];

            // ç”¢ç”ŸåŒ…å«æ­£ç¢ºç­”æ¡ˆçš„ 4 çµ„æ•¸å­—
            //if (answer == multiplicand)
              //let optionsArr = [answer, answer+1, answer+2, answer+3];
            //else
              let optionsArr = [answer, answer+1, answer+multiplicand, answer-multiplicand+1];
            
            // æ´—ç‰Œé¡¯ç¤ºä½ç½®
            optionsArr.sort(() => Math.random() - 0.5);

            const btns = document.querySelectorAll('.ans-btn');
            btns.forEach((btn, idx) => {
                btn.innerText = optionsArr[idx];
                btn.dataset.val = optionsArr[idx];
            });
        }

        function checkAnswer(index) {
            if (isRoundFinished) return; // å·²ç¶“ç­”å°éäº†ï¼Œç­‰å¾…æŒ‰ä¸‹ä¸€é¡Œ

            const btns = document.querySelectorAll('.ans-btn');
            const clickedBtn = btns[index];
            const val = parseInt(clickedBtn.dataset.val);

            const fbText = document.getElementById('feedback-text');
            const fbAnim = document.getElementById('feedback-anim');

            if (val === currentAnswer) {
                // --- ç­”å° ---
                isRoundFinished = true; // æœ¬é¡ŒçµæŸ
                score++;
                updateUI();
                
                // è¦–è¦ºå›é¥‹
                fbText.innerText = "å¤ªæ£’äº†ï¼ä½ ç­”å°äº†";
                fbText.style.color = "#2ECC71";
                fbAnim.innerText = "ğŸ‘"; 
                fbAnim.className = "feedback-anim anim-clap"; // æ‹æ‰‹å‹•ç•«
                
                // è½è¦ºå›é¥‹
                playTone('win');

                // æŒ‰éˆ•è®Šç¶ 
                clickedBtn.style.backgroundColor = "#2ECC71";

                // é–å®šæ‰€æœ‰æŒ‰éˆ•
                btns.forEach(b => b.classList.add('locked'));

            } else {
                // --- ç­”éŒ¯ ---
                // ä¸çµæŸæœ¬é¡Œï¼Œå…è¨±é‡è©¦
                faultScore++;
                updateUI();
                
                // è¦–è¦ºå›é¥‹
                fbText.innerText = "å–”å–”ï¼å†æƒ³æƒ³";
                fbText.style.color = "#E74C3C";
                fbAnim.innerText = "ğŸ¤¦â€â™‚ï¸"; // æ›å€‹ç”Ÿå‹•çš„ emojiï¼Œå¦‚æ©é¢æˆ–æ–é ­
                // å…ˆç§»é™¤å‹•ç•«å†åŠ å…¥ï¼Œç¢ºä¿æ¯æ¬¡éƒ½èƒ½è§¸ç™¼æ–å‹•
                fbAnim.classList.remove('anim-shake');
                void fbAnim.offsetWidth; // Trigger reflow
                fbAnim.classList.add('anim-shake'); // æ–é ­å‹•ç•«

                // è½è¦ºå›é¥‹
                playTone('lose');

                // éŒ¯èª¤æŒ‰éˆ•è®Šç°ä¸¦é–å®š (ä½†å…¶ä»–æŒ‰éˆ•ä¿æŒå¯æŒ‰)
                clickedBtn.classList.add('wrong-choice');
            }
        }

        function updateUI() {
            document.getElementById('score-val').innerText = score;
            document.getElementById('fault-val').innerText = faultScore;
        }

        function endGameNow() {
            clearInterval(timerInterval);
            location.reload(); // è¿”å›é¦–é 
        }

        function gameOver() {
            clearInterval(timerInterval);
            document.getElementById('modal-result').style.display = 'flex';
            document.getElementById('final-msg').innerText = `ç­”å° ${score} é¡Œï¼Œç­”éŒ¯ ${faultScore} æ¬¡`;
            playTone('win'); // çµæŸæ™‚æ’­æ”¾ä¸€æ¬¡å‹åˆ©éŸ³æ•ˆ
        }
    </script>
</body>
</html>
